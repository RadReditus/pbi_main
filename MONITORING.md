# Мониторинг OData источников

## Описание функционала

Система мониторинга автоматически отслеживает изменения в OData источниках 1С и синхронизирует данные при необходимости.

## Основные возможности

### 1. Автоматический мониторинг
- **Периодичность**: каждые 5 минут
- **Проверка**: сравнение количества записей в OData источнике с локальной базой данных
- **Синхронизация**: автоматическое обновление данных при обнаружении изменений

### 2. Управление счетчиками
- **Отслеживание**: количества записей по каждой таблице
- **Статус**: актуальность данных (актуально/требует обновления)
- **История**: время последней проверки и обновления

### 3. Веб-интерфейс
- **Дашборд**: общая статистика по всем таблицам
- **Таблица счетчиков**: детальная информация по каждой таблице
- **Управление**: принудительная проверка и синхронизация

## Архитектура

### Backend компоненты

#### TableCounter Entity
```typescript
@Entity()
export class TableCounter {
  id: string;                    // UUID
  tableName: string;             // Имя таблицы
  baseUrl: string;               // Базовый URL OData источника
  collectionName: string;        // Имя коллекции
  currentCount: number;          // Текущее количество записей
  lastSyncedCount: number;       // Количество записей при последней синхронизации
  needsUpdate: boolean;          // Требует ли обновления
  lastCheckedAt: Date;           // Время последней проверки
  lastUpdatedAt: Date;           // Время последнего обновления
}
```

#### MonitoringService
- **@Cron('0 0 * * *', { timeZone: 'Asia/Almaty' })**: автоматический запуск ежедневно в 00:00 по казахстанскому времени (UTC+3)
- **checkCollectionChanges()**: проверка изменений в конкретной коллекции
- **getRemoteRecordCount()**: получение количества записей из OData источника
- **syncTableData()**: синхронизация данных таблицы

#### MonitoringController
- **GET /monitoring/counters**: получение списка счетчиков
- **GET /monitoring/stats**: получение статистики мониторинга
- **POST /monitoring/force-check**: принудительная проверка всех таблиц
- **POST /monitoring/force-sync/:tableName**: принудительная синхронизация таблицы

### Frontend компоненты

#### Monitoring Page
- **Статистика**: общее количество таблиц, актуальные, требующие обновления
- **Таблица счетчиков**: детальная информация с возможностью принудительной синхронизации
- **Автообновление**: обновление данных каждые 30 секунд

## Процесс работы

### 1. Инициализация
1. При первом запуске создается запись счетчика для каждой коллекции
2. Устанавливается начальное значение счетчиков (0)

### 2. Цикл мониторинга (каждые 5 минут)
1. **Получение списка коллекций** из DatasCollectionsService
2. **Для каждой коллекции**:
   - Получение количества записей из OData источника
   - Сравнение с локальным счетчиком
   - Обновление статуса (needsUpdate)
   - При необходимости - синхронизация данных

### 3. Синхронизация данных
1. **Получение данных** из OData источника
2. **Обновление таблицы** в PostgreSQL
3. **Обновление счетчика** (lastSyncedCount = currentCount)
4. **Сброс флага** needsUpdate = false

## API Endpoints

### GET /api/v1/monitoring/counters
Возвращает список всех счетчиков таблиц.

**Ответ:**
```json
[
  {
    "id": "uuid",
    "tableName": "odata_collection_name",
    "baseUrl": "http://1c-server/odata",
    "collectionName": "CollectionName",
    "currentCount": 1500,
    "lastSyncedCount": 1500,
    "needsUpdate": false,
    "lastCheckedAt": "2024-01-01T12:00:00Z",
    "lastUpdatedAt": "2024-01-01T11:55:00Z"
  }
]
```

### GET /api/v1/monitoring/stats
Возвращает общую статистику мониторинга.

**Ответ:**
```json
{
  "totalTables": 5,
  "upToDateTables": 4,
  "needsUpdateTables": 1,
  "lastCheckTime": "2024-01-01T12:00:00Z"
}
```

### POST /api/v1/monitoring/force-check
Запускает принудительную проверку всех таблиц.

### POST /api/v1/monitoring/force-sync/:tableName
Запускает принудительную синхронизацию указанной таблицы.

## Настройка

### Переменные окружения
```env
# Настройки OData источников
SOURCE1C_USERNAME=Power_BI
SOURCE1C_PASSWORD=Y#632754265740oq
SOURCE1C_TIMEOUT_MS=120000

# Периодичность мониторинга (в cron формате)
MONITORING_CRON_EXPRESSION=0 */5 * * * *
```

### Права доступа
- **ADMIN**: полный доступ ко всем функциям мониторинга
- **ASSISTANT**: просмотр статистики и счетчиков
- **USER**: доступ запрещен

## Мониторинг и логирование

### Логи
- **INFO**: успешные операции мониторинга
- **WARN**: предупреждения (например, недоступность источника)
- **ERROR**: ошибки синхронизации

### Метрики
- Количество проверенных таблиц
- Время выполнения проверки
- Количество обновленных таблиц
- Статус каждой таблицы

## Устранение неполадок

### Проблемы с подключением к OData
1. Проверить доступность источника
2. Проверить учетные данные
3. Проверить таймауты

### Проблемы с синхронизацией
1. Проверить логи MonitoringService
2. Проверить права доступа к базе данных
3. Проверить целостность данных

### Высокая нагрузка
1. Увеличить интервал между проверками
2. Оптимизировать запросы к OData
3. Добавить кэширование



